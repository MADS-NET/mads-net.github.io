<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Paolo Bosetti">
<meta name="dcterms.date" content="2025-07-07">

<title>Parallel computing with MADS – MADS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0829b0b756d6a27eb117278c0ab9cd09.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-bbb3aa00460f0e65c0ac78c75fee982e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="https://avatars.githubusercontent.com/u/177097168?s=200&amp;v=4" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">MADS</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../guides.html"> 
<span class="menu-text">Guides</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#mads-solution" id="toc-mads-solution" class="nav-link" data-scroll-target="#mads-solution">MADS solution</a></li>
  <li><a href="#resource-scaling" id="toc-resource-scaling" class="nav-link" data-scroll-target="#resource-scaling">Resource scaling</a>
  <ul class="collapse">
  <li><a href="#example-deployment" id="toc-example-deployment" class="nav-link" data-scroll-target="#example-deployment">Example deployment</a></li>
  <li><a href="#keeping-track-of-completed-tasks" id="toc-keeping-track-of-completed-tasks" class="nav-link" data-scroll-target="#keeping-track-of-completed-tasks">Keeping track of completed tasks</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Parallel computing with MADS</h1>
  <div class="quarto-categories">
    <div class="quarto-category">plugin</div>
    <div class="quarto-category">parallel computing</div>
    <div class="quarto-category">advanced</div>
    <div class="quarto-category">kubernetes</div>
    <div class="quarto-category">docker</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Paolo Bosetti </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Trento
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 7, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">July 7, 2025</p>
    </div>
  </div>
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>MADS has two special agents, <code>dealer</code> and <code>worker</code>, thatallow to distribute many different computations to a set of identical workers, in round-robin fashion.</p>
  </div>
</div>


</header>


<section id="motivation" class="level1">
<h1>Motivation</h1>
<p>Sometimes, we want to explore a large parameter space, and run multiple time-demanding simulations over a grid of points in the parameter space. This is the case for example when we want to run a sensitivity analysis, or when we want to explore the effect of different parameters on the model output and perhaps find the optimal set of parameters for a given objective function.</p>
<p>If we have at hand a number of machines with multiple cores, we can effectively scale the problem by running each simulation on a different machine, or on a different core of the same machine. This is particularly useful when the simulations are independent and can be run in parallel.</p>
</section>
<section id="mads-solution" class="level1">
<h1>MADS solution</h1>
<p>MADS has two special agents, <code>dealer</code> and <code>worker</code>, that allow to distribute many different computations to a set of identical workers, in round-robin fashion. This is useful when you have many independent tasks that can be run in parallel, such as running multiple simulations or processing large datasets.</p>
<p>This configuration exploits ZeroMQ’s feature called <a href="https://zguide.zeromq.org/docs/chapter2/#Messaging-Patterns">“PUSH-PULL”</a> to distribute tasks among workers. The <code>dealer</code> agent acts as a task distributor, while the <code>worker</code> agents are responsible for executing the tasks. Once a <code>worker</code> completes a task, it sends the result back to the MADS net — which can then process or store the results as needed — and becomes available again for new tasks.</p>
<p>The scheme is illustrated in Figure <a href="#fig-net" class="quarto-xref">Figure&nbsp;1</a>. In this installation, the network has a broker, a logger (connected to the MongoDB database), and a generic source plugin, which is expected to generate the computational load, i.e., a sequence of <strong>input tasks</strong> (as JSON object). The source plugin can be freely implemented (monolithic, plugin, or even a python agent).</p>
<p>A special agent, called <code>dealer</code>, which is part of standard MADS distribution, is also connected to the broker. It also provides connection to the workers on an additional port, by default 9093 (blue arrows in <a href="#fig-net" class="quarto-xref">Figure&nbsp;1</a>).</p>
<div class="cell" data-fig-width="6" data-fig-height="3" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-net" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-net-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<svg width="576" height="288" viewbox="0.00 0.00 484.24 273.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 269)">
<title>Dealer-worker</title>
<polygon fill="transparent" stroke="transparent" points="-4,4 -4,-269 480.24,-269 480.24,4 -4,4"></polygon>
<!-- broker -->
<g id="node1" class="node">
<title>broker</title>
<polygon fill="#ffffff" stroke="black" points="145,-138 91,-138 91,-102 145,-102 145,-138"></polygon>
<text text-anchor="middle" x="118" y="-115.8" font-family="Times,serif" font-size="14.00">broker</text>
</g>
<!-- dealer -->
<g id="node3" class="node">
<title>dealer</title>
<polygon fill="#f0f0f0" stroke="black" points="236,-168 182,-168 182,-132 236,-132 236,-168"></polygon>
<text text-anchor="middle" x="209" y="-145.8" font-family="Times,serif" font-size="14.00">dealer</text>
</g>
<!-- broker&#45;&gt;dealer -->
<g id="edge6" class="edge">
<title>broker-&gt;dealer</title>
<path fill="none" stroke="black" d="M145.22,-128.84C153.73,-131.71 163.32,-134.94 172.4,-138"></path>
<polygon fill="black" stroke="black" points="171.37,-141.35 181.97,-141.22 173.61,-134.71 171.37,-141.35"></polygon>
</g>
<!-- logger -->
<g id="node10" class="node">
<title>logger</title>
<polygon fill="#ffffff" stroke="black" points="236,-36 182,-36 182,0 236,0 236,-36"></polygon>
<text text-anchor="middle" x="209" y="-13.8" font-family="Times,serif" font-size="14.00">logger</text>
</g>
<!-- broker&#45;&gt;logger -->
<g id="edge15" class="edge">
<title>broker-&gt;logger</title>
<path fill="none" stroke="black" d="M127.78,-101.99C135.65,-86.99 148.21,-65.65 163,-50 166.28,-46.52 170,-43.19 173.84,-40.07"></path>
<polygon fill="black" stroke="black" points="175.99,-42.83 181.84,-34 171.76,-37.26 175.99,-42.83"></polygon>
</g>
<!-- source -->
<g id="node2" class="node">
<title>source</title>
<polygon fill="#ffffff" stroke="black" points="54,-138 0,-138 0,-102 54,-102 54,-138"></polygon>
<text text-anchor="middle" x="27" y="-115.8" font-family="Times,serif" font-size="14.00">source</text>
</g>
<!-- source&#45;&gt;broker -->
<g id="edge5" class="edge">
<title>source-&gt;broker</title>
<path fill="none" stroke="black" d="M54.22,-120C62.55,-120 71.91,-120 80.82,-120"></path>
<polygon fill="black" stroke="black" points="80.97,-123.5 90.97,-120 80.97,-116.5 80.97,-123.5"></polygon>
</g>
<!-- w1 -->
<g id="node5" class="node">
<title>w1</title>
<polygon fill="#f0f0f0" stroke="black" points="380.44,-265 314.14,-265 314.14,-229 380.44,-229 380.44,-265"></polygon>
<text text-anchor="middle" x="347.29" y="-242.8" font-family="Times,serif" font-size="14.00">worker 1</text>
</g>
<!-- dealer&#45;&gt;w1 -->
<g id="edge7" class="edge">
<title>dealer-&gt;w1</title>
<path fill="none" stroke="blue" d="M233.1,-168.26C239.78,-173.43 247.13,-179.01 254,-184 272.31,-197.31 293.1,-211.57 310.3,-223.15"></path>
<polygon fill="blue" stroke="blue" points="308.69,-226.28 318.94,-228.95 312.59,-220.47 308.69,-226.28"></polygon>
</g>
<!-- w2 -->
<g id="node6" class="node">
<title>w2</title>
<polygon fill="#f0f0f0" stroke="black" points="380.44,-103 314.14,-103 314.14,-67 380.44,-67 380.44,-103"></polygon>
<text text-anchor="middle" x="347.29" y="-80.8" font-family="Times,serif" font-size="14.00">worker 2</text>
</g>
<!-- dealer&#45;&gt;w2 -->
<g id="edge8" class="edge">
<title>dealer-&gt;w2</title>
<path fill="none" stroke="blue" d="M236.28,-137.47C255.64,-128.24 282.35,-115.49 304.61,-104.88"></path>
<polygon fill="blue" stroke="blue" points="306.32,-107.94 313.84,-100.48 303.31,-101.62 306.32,-107.94"></polygon>
</g>
<!-- w3 -->
<g id="node7" class="node">
<title>w3</title>
<polygon fill="#f0f0f0" stroke="black" points="380.44,-157 314.14,-157 314.14,-121 380.44,-121 380.44,-157"></polygon>
<text text-anchor="middle" x="347.29" y="-134.8" font-family="Times,serif" font-size="14.00">worker 3</text>
</g>
<!-- dealer&#45;&gt;w3 -->
<g id="edge9" class="edge">
<title>dealer-&gt;w3</title>
<path fill="none" stroke="blue" d="M236.28,-147.88C255.38,-146.34 281.64,-144.22 303.71,-142.44"></path>
<polygon fill="blue" stroke="blue" points="304.16,-145.91 313.84,-141.62 303.59,-138.93 304.16,-145.91"></polygon>
</g>
<!-- w4 -->
<g id="node8" class="node">
<title>w4</title>
<polygon fill="#f0f0f0" stroke="black" points="380.44,-211 314.14,-211 314.14,-175 380.44,-175 380.44,-211"></polygon>
<text text-anchor="middle" x="347.29" y="-188.8" font-family="Times,serif" font-size="14.00">worker 4</text>
</g>
<!-- dealer&#45;&gt;w4 -->
<g id="edge10" class="edge">
<title>dealer-&gt;w4</title>
<path fill="none" stroke="blue" d="M236.28,-158.29C255.46,-164.34 281.88,-172.68 304.01,-179.66"></path>
<polygon fill="blue" stroke="blue" points="303.25,-183.09 313.84,-182.76 305.36,-176.42 303.25,-183.09"></polygon>
</g>
<!-- mongo -->
<g id="node4" class="node">
<title>mongo</title>
<path fill="#ffffff" stroke="black" d="M385.19,-32.73C385.19,-34.53 368.2,-36 347.29,-36 326.38,-36 309.4,-34.53 309.4,-32.73 309.4,-32.73 309.4,-3.27 309.4,-3.27 309.4,-1.47 326.38,0 347.29,0 368.2,0 385.19,-1.47 385.19,-3.27 385.19,-3.27 385.19,-32.73 385.19,-32.73"></path>
<path fill="none" stroke="black" d="M385.19,-32.73C385.19,-30.92 368.2,-29.45 347.29,-29.45 326.38,-29.45 309.4,-30.92 309.4,-32.73"></path>
<text text-anchor="middle" x="347.29" y="-13.8" font-family="Times,serif" font-size="14.00">MongoDB</text>
</g>
<!-- w1&#45;&gt;broker -->
<g id="edge11" class="edge">
<title>w1-&gt;broker</title>
<path fill="none" stroke="black" d="M314.13,-242.48C279.56,-236.55 223.93,-223.84 182,-199 161.18,-186.67 144.5,-164.68 133.55,-147.03"></path>
<polygon fill="black" stroke="black" points="136.47,-145.09 128.35,-138.27 130.45,-148.66 136.47,-145.09"></polygon>
</g>
<!-- p -->
<g id="node9" class="node">
<title>p</title>
<polygon fill="#ffffff" stroke="black" points="434.24,-153 476.24,-153 476.24,-177 434.24,-177 422.24,-165 434.24,-153"></polygon>
<text text-anchor="middle" x="449.24" y="-160.8" font-family="Times,serif" font-size="14.00">Plugin</text>
</g>
<!-- w1&#45;&gt;p -->
<g id="edge1" class="edge">
<title>w1-&gt;p</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M373.56,-228.99C377.51,-226.04 381.52,-222.98 385.24,-220 400.1,-208.12 416.25,-194 428.47,-183.04"></path>
</g>
<!-- w2&#45;&gt;broker -->
<g id="edge12" class="edge">
<title>w2-&gt;broker</title>
<path fill="none" stroke="black" d="M313.96,-89.98C271.93,-96.45 198.75,-107.72 155,-114.46"></path>
<polygon fill="black" stroke="black" points="154.42,-111 145.07,-115.99 155.49,-117.92 154.42,-111"></polygon>
</g>
<!-- w2&#45;&gt;p -->
<g id="edge2" class="edge">
<title>w2-&gt;p</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M373.51,-103.07C377.47,-106.01 381.49,-109.06 385.24,-112 399.64,-123.29 415.39,-136.54 427.54,-146.97"></path>
</g>
<!-- w3&#45;&gt;broker -->
<g id="edge13" class="edge">
<title>w3-&gt;broker</title>
<path fill="none" stroke="black" d="M314.07,-133.3C292.14,-129.67 262.41,-125.25 236,-123 208.96,-120.7 178.29,-119.98 155.14,-119.82"></path>
<polygon fill="black" stroke="black" points="155.08,-116.32 145.07,-119.79 155.06,-123.32 155.08,-116.32"></polygon>
</g>
<!-- w3&#45;&gt;p -->
<g id="edge3" class="edge">
<title>w3-&gt;p</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M380.47,-147.37C393.94,-150.87 409.39,-154.89 422.13,-158.21"></path>
</g>
<!-- w4&#45;&gt;broker -->
<g id="edge14" class="edge">
<title>w4-&gt;broker</title>
<path fill="none" stroke="black" d="M313.91,-195.68C279.65,-197.21 224.72,-195.89 182,-177 166.06,-169.96 151.42,-157.28 140.27,-145.66"></path>
<polygon fill="black" stroke="black" points="142.81,-143.25 133.47,-138.25 137.65,-147.99 142.81,-143.25"></polygon>
</g>
<!-- w4&#45;&gt;p -->
<g id="edge4" class="edge">
<title>w4-&gt;p</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M380.47,-183.99C393.94,-180.21 409.39,-175.88 422.13,-172.31"></path>
</g>
<!-- logger&#45;&gt;mongo -->
<g id="edge16" class="edge">
<title>logger-&gt;mongo</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M236.28,-18C254.09,-18 278.14,-18 299.21,-18"></path>
<polygon fill="black" stroke="black" points="299.28,-21.5 309.28,-18 299.28,-14.5 299.28,-21.5"></polygon>
<text text-anchor="middle" x="272.67" y="-22.2" font-family="Times,serif" font-size="14.00">BSON</text>
</g>
</g>
</svg>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-net-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Dealer-Worker
</figcaption>
</figure>
</div>
</div>
</div>
<p>A variable number of <code>worker</code> agents (also part of MADS distribution) are then connected to the <code>dealer</code> with a PUSH-PULL ZeroMQ socket, and also act as source agents towards the broker.</p>
<p>Workers are plugin-based agents, and typically all load the same plugin file (preferably obtained OTA).</p>
<p>As soon as the broker receives a new task from <code>source</code>, it dispatches it to the <code>dealer</code>, which then forwards it to the next available <code>worker</code>. The <code>worker</code> executes the task and sends the result back to the broker, which can then routes the results to any subscribed agent (e.g.&nbsp;the <code>logger</code>).</p>
</section>
<section id="resource-scaling" class="level1">
<h1>Resource scaling</h1>
<p>The worker instances in <a href="#fig-net" class="quarto-xref">Figure&nbsp;1</a> can be fun on the same machine/device, or on different machine, in a way that is totally irrelevant and transparent to the MADS network. The only requirement is that the <code>dealer</code> and the <code>worker</code> agents are connected to the same broker, and that the <code>worker</code> agents are able to connect to the <code>dealer</code> on the port 9093 (or any other port specified in the configuration).</p>
<p>Of course, if the number of machines for running the workers becomes large enough, it would be impractical to manually install and load the workers on tens or hundreds of machines. In this case, it is possible to use a <em>container orchestration system</em> such as <strong>Kubernetes</strong> to automatically deploy and manage the worker instances.</p>
<p>In this case, we have a Kubernetes deployment that defines a containerized list of MADS worker agents, each then loading the computation plugin via OTA from the broker. Once the Kubernetes cluster is set up, scaling it is just a matter of adding more machines to the same cluster and dynamically request the desired number of replicas.</p>
<section id="example-deployment" class="level2">
<h2 class="anchored" data-anchor-id="example-deployment">Example deployment</h2>
<p>Kubernetes deployments are YAML files that declare the configuration for each instance. a workable example is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> worker</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> worker</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> worker</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> worker</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">"p4010/mads:latest"</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">args</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"worker"</span><span class="kw">,</span><span class="at"> </span><span class="st">"-s"</span><span class="kw">,</span><span class="at"> </span><span class="st">"tcp://198.19.249.3:9092"</span><span class="kw">,</span><span class="at"> </span><span class="st">"-n"</span><span class="kw">,</span><span class="at"> </span><span class="st">"test_worker_arm64"</span><span class="kw">]</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 200m</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 500Mi</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 100m</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 200Mi</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">9091</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">name</span><span class="kw">:</span><span class="at"> zmq-in</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">9092</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">name</span><span class="kw">:</span><span class="at"> zmq-ini</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">9093</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">name</span><span class="kw">:</span><span class="at"> zmq-deal</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is defining each worker as an instance of the <code>p4010/mads:latest</code> Docker image, which is the official MADS image on Docker Hub. The <code>args</code> field specifies the command line arguments to pass to the worker agent, including the broker address and the worker name. In this case, we are assuming that Kubernetes runs on an ARM64 architecture, and the worker name is set to <code>test_worker_arm64</code> (see <a href="../guides/OTA_plugins.html">OTA Plugins</a> for more details on the worker name).</p>
<p>With this configuration saved as `<code>manifest.yml</code>, we can deploy the workers to the Kubernetes cluster with the following command:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> manifest.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will start 5 replicas of the same worker instance, each loading the plugin OTA from the broker. If we want (and can) scale up the number of workers, we can do it transparently without disrupting any operation:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> scale deployments/worker <span class="at">--replicas</span><span class="op">=</span>100</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The maximum number of replicas shall be less or equal to the <strong>total number of cores in the Kubernetes cluster</strong>. If you try to scale up beyond that, CPU resources will be further subdivided among the workers, and each worker will get less CPU time, which may lead to performance degradation.</p>
</div>
</div>
<p>When we are done, we can scale down the number of workers to zero, or delete the deployment altogether:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> delete deployments worker</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="keeping-track-of-completed-tasks" class="level2">
<h2 class="anchored" data-anchor-id="keeping-track-of-completed-tasks">Keeping track of completed tasks</h2>
<p>The number of submitted and completed tasks can be easily monitored with a Python agent:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>agent_type <span class="op">=</span> <span class="st">"sink"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup():</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"[Python] Setting up sink..."</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"[Python] Parameters: "</span> <span class="op">+</span> json.dumps(params))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  state[<span class="st">"submitted"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  state[<span class="st">"accepted"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deal_with_data():</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> topic <span class="op">==</span> <span class="st">"dealer"</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    state[<span class="st">"submitted"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> topic <span class="op">==</span> <span class="st">"test_worker"</span>:</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    state[<span class="st">"accepted"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"</span><span class="ch">\33</span><span class="st">[2K[Python] Submitted: "</span> <span class="op">+</span> <span class="bu">str</span>(state[<span class="st">"submitted"</span>]) <span class="op">+</span> <span class="st">", Accepted: "</span> <span class="op">+</span> <span class="bu">str</span>(state[<span class="st">"accepted"</span>]) <span class="op">+</span> <span class="st">", Pending: "</span> <span class="op">+</span> <span class="bu">str</span>(state[<span class="st">"submitted"</span>] <span class="op">-</span> state[<span class="st">"accepted"</span>]), end<span class="op">=</span><span class="st">"</span><span class="ch">\r</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Save this as <code>counter.py</code> in the folder <code>usr/local/scripts</code> under the MADS prefix directory (given by <code>mads -p</code>), add the following section to the INI file:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[counter]</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">sub_topic </span><span class="ot">=</span><span class="st"> ["dealer", "test_worker"]</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">python_module </span><span class="ot">=</span><span class="st"> "counter"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>then run the agent with the command:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mads</span> python <span class="at">-n</span> counter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mads-net\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>